<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="965" height="400"
		   styleName="backgroundSubmit" xmlns:local="*">
	<mx:Script>
		<![CDATA[
			import com.adobe.serialization.json.JSON;
			import com.adobe.utils.IntUtil;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.core.Application;
			import mx.events.ValidationResultEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.ResultEvent;
			
			public var citiesData:ArrayCollection = new ArrayCollection(
				[ {label:"-Chọn-", data:0},
					{label:"Hậu Giang", data:1},
					{label:"Đắk Lắc", data:2},
					{label:"Đắk Nông", data:3},
					{label:"Điện Biên", data:4},
					{label:"Hà Nội", data:5},
					{label:"TP Hồ Chí Minh", data:6},
					{label:"Đà Nẵng", data:7},
					{label:"Nha Trang", data:8},
					{label:"Hải Phòng", data:9},
					{label:"Bắc Giang", data:10},
					{label:"Bạc Liêu", data:11},
					{label:"Vũng Tàu", data:12},
					{label:"Bắc Cạn", data:13},
					{label:"Bắc Ninh", data:14},
					{label:"Quảng Ninh", data:15},
					{label:"Bến Tre", data:16},
					{label:"Cần Thơ", data:17},
					{label:"Bình Dương", data:18},
					{label:"Bình Định", data:19},
					{label:"Bình Phước", data:20},
					{label:"Bình Thuận", data:21},
					{label:"Cà Mau", data:22},
					{label:"Cao Bằng", data:23},
					{label:"Đồng Nai", data:24},
					{label:"Đồng Tháp", data:25},
					{label:"Gia Lai", data:26},
					{label:"Hà Giang", data:27},
					{label:"Hà Nam", data:28},
					{label:"Hà Tây", data:29},
					{label:"Hà Tĩnh", data:30},
					{label:"Hải Dương", data:31},
					{label:"Hòa Bình", data:32},
					{label:"Hưng Yên", data:33},
					{label:"Khánh Hòa", data:34},
					{label:"Kiên Giang", data:35},
					{label:"Kon Tum", data:36},
					{label:"Lai Châu", data:37},
					{label:"Lạng Sơn", data:38},
					{label:"Lào Cai", data:39},
					{label:"Lâm Đồng", data:40},
					{label:"Long An", data:41},
					{label:"Nam Định", data:42},
					{label:"Nghệ An", data:43},
					{label:"Ninh Bình", data:44},
					{label:"Ninh Thuận", data:45},
					{label:"Phú Thọ", data:46},
					{label:"Phú Yên", data:47},
					{label:"Quảng Bình", data:48},
					{label:"Quảng Nam", data:49},
					{label:"Quảng Ngãi", data:50},
					{label:"Quảng Trị", data:51},
					{label:"Sóc Trăng", data:52},
					{label:"Sơn La", data:53},
					{label:"Tây Ninh", data:54},
					{label:"Thái Bình", data:55},
					{label:"Thái Nguyên", data:56},
					{label:"Thanh Hóa", data:57},
					{label:"Thừa Thiên Huế", data:58},
					{label:"Tiền Giang", data:59},
					{label:"Trà Vinh", data:60},
					{label:"Tuyên Quang", data:61},
					{label:"Vĩnh Long", data:62},
					{label:"Vĩnh Phúc", data:63},
					{label:"An giang", data:64},
					{label:"Yên Bái", data:65}
					 ]);
			
			const dobHint:String = "DD/MM/YYYY, ví dụ: 19/03/1986";
			
			function dobFocusIn() {
				if (dob.text == dobHint) {
					dob.text = "";
				}
			}
			function dobFocusOut() {
				if (isEmpty(dob.text)) {
					dob.text = dobHint;
				}
			}
			
			function finishSendResult(event:ResultEvent) {
				var JSONResArr:String = String(httpSendResult.lastResult);	
				var result:Object = JSON.decode(JSONResArr);
				if (result.result == null) {
					Alert.show(result.error);
					return;
				} else {
					Application.application.updateHighscoreList();
					PopUpManager.removePopUp(this);
				}
			}
			
			function finishGetUserInfo(event:ResultEvent) {
				var JSONResArr:String = String(httpGetUserInfo.lastResult);
				if (JSONResArr != null && JSONResArr.length > 0) {
					var result:Object = JSON.decode(JSONResArr);
					if (result.error != null) return;
					idCarNo.text = result[0].cmnd;
					phone.text = result[0].phone;
					address.text = result[0].address;
					for (var i = 0; i < citiesData.length; i++) {
						if (citiesData.getItemAt(i).label == result[0].city) {
							cities.selectedIndex = i;
							break;
						}
					}
					email.text = result[0].email;
				}
				
			}
			
			function validate():Boolean {
				if(isEmpty(txtName.text)) {
					alertMissingField("Họ và tên");
					txtName.setFocus();
					return false;
				}
				if (isEmpty(idCarNo.text)) {
					alertMissingField("CMND");
					idCarNo.setFocus();
					return false;
				}
				if (isEmpty(dob.text) || dob.text == dobHint) {
					alertMissingField("Ngày sinh");
					dob.setFocus();
					return false;
				}
				if (isEmpty(phone.text)) {
					alertMissingField("Điện thoại");
					phone.setFocus();
					return false;
				}
				if (isEmpty(address.text)) {
					alertMissingField("Địa chỉ");
					address.setFocus();
					return false;
				}
				if (cities.selectedItem.data == 0) {
					alertMissingField("Thành phố");
					cities.setFocus();
					return false;
				}
				if (isEmpty(email.text)) {
					alertMissingField("Email");
					email.setFocus();
					return false;
				}
				
				return true;
			}
			
			function isEmpty(str:String) {
				return str == null || str.length == 0;
			}
			
			function alertMissingField(field:String) {
				Alert.show("Hãy điền vào ô \"" + field + "\"");
			}
			
			function onSendButtonClicked() {
				if (!validate()) return;
				
				var params:Object = new Object();
				params.a = "post";
				params.fullname = txtName.text;
				params.cmnd = idCarNo.text;
				params.dob = dob.text;
				params.phone = phone.text;
				params.address = address.text;
				params.city = citiesData.getItemAt(cities.selectedIndex).label;
				params.email = email.text;
				params.score = encrypt(Application.application.totalScore);
				httpSendResult.send(params);
				
				PopUpManager.removePopUp(this);
			}
			
			function encrypt(score:int):Number {
				return score * score * 47
			}
			
			function autoComplete() {
				if (txtName.text == null || txtName.text.length == 0) return;
				
				var params = new Object();
				params.a = "get";
				params.fullname = txtName.text;
				httpGetUserInfo.send(params);
			}
		]]>
	</mx:Script>
	<mx:Canvas styleName="textbox1" x="265" y="119" width="298" height="30">
		<mx:TextInput id="txtName" focusOut="{autoComplete();}" 
					  borderSkin="{null}" backgroundAlpha="0" themeColor="#ffffff"
					  width="286" height="18" x="6" y="6" />
	</mx:Canvas>
	<mx:Canvas styleName="textbox1" x="265" y="152" width="298" height="30">
		<mx:TextInput id="idCarNo" 
					  borderSkin="{null}" backgroundAlpha="0" themeColor="#ffffff"
					  width="286" height="18" x="6" y="6" />
	</mx:Canvas>
	<mx:Canvas styleName="textbox3" x="265" y="185" width="224" height="30">
		<mx:TextInput id="dob" 
					  borderSkin="{null}" backgroundAlpha="0" themeColor="#ffffff"
					  width="212" height="18" x="6" y="6"
					  text="{dobHint}"
					  focusIn="dobFocusIn()"
					  focusOut="dobFocusOut()"
					  />
	</mx:Canvas>
	<mx:Canvas styleName="textbox1" x="265" y="218" width="298" height="30">
		<mx:TextInput id="phone"
					  borderSkin="{null}" backgroundAlpha="0" themeColor="#ffffff"
					  width="286" height="18" x="6" y="6" />
	</mx:Canvas>
	<mx:Canvas styleName="combobox" x="265" y="251" width="103" height="30" horizontalScrollPolicy="off" verticalScrollPolicy="off">
		<mx:ComboBox id="cities" dataProvider="{citiesData}"
					 themeColor="#ffffff" fillAlphas="[0,0]" fillColors="[#ffffff, #ffffff]"
					 width="91" height="18" x="6" y="6" />
		<mx:Image source="@Embed(source='assets/combobox_arrow.png')" x="81" y="10"/>
	</mx:Canvas>
	<mx:Canvas styleName="textbox2" x="423" y="251" width="142" height="30">
		<mx:TextInput id="address"
					  borderSkin="{null}" backgroundAlpha="0" themeColor="#ffffff"
					  width="130" height="18" x="6" y="6" />
	</mx:Canvas>
	<mx:Canvas styleName="textbox3" x="265" y="284" width="224" height="30">
		<mx:TextInput id="email"
					 borderSkin="{null}" backgroundAlpha="0" themeColor="#ffffff"
					 width="212" height="18" x="6" y="6" />
	</mx:Canvas>
	
	<local:NoCachingHttpService
		id="httpSendResult"
		url="http://mekongmedia.com.vn/reeva3mien/info.php"
		method="POST"
		resultFormat="object"
		result="finishSendResult(event)"
		/>
	<local:NoCachingHttpService
		id="httpGetUserInfo"
		url="http://mekongmedia.com.vn/reeva3mien/info.php"
		method="GET"
		resultFormat="object"
		result="finishGetUserInfo(event)"
		/>
	<mx:Image source="@Embed(source='assets/but_ok.png')" x="554" y="291" click="onSendButtonClicked()"
			  useHandCursor="true" buttonMode="true"/>
</mx:Canvas>
